---
tags:
  - MALWARE-ANALISYS
  - LetsDefend
---
## **O que é embalagem e desempacoamento?**
"Packing" refere-se ao procedimento de transformar um arquivo executável em um formato de arquivo diferente usando um algoritmo especial para objetivos específicos. Por outro lado, "desempacotamento" denota o processo de reverter o arquivo embalado para o seu formulário original, essencialmente invertendo o procedimento de embalagem. 


Detalhes sobre as operações de embalagem / desempacotamento são explicados nos seguintes tópicos.

![](https://letsdefend-images.s3.us-east-2.amazonaws.com/Courses/Static-Malware-Analysis/4.Packing+and+Unpacking/packing1.png)

  
  

A imagem exibida acima mostra a estrutura do arquivo de um arquivo executável do Windows antes e depois do processo de embalagem.

---
## **O que a embalagem fornece?**
A embalagem usa um algoritmo que causa alterações estruturais no arquivo executável. Este algoritmo oferece várias vantagens significativas, incluindo:

- Torna o arquivo executável menor em tamanho.
- Impede obter informações sobre o arquivo por análise estática usando técnicas de engenharia reversa.
- Impede ou dificulta a detecção por produtos de segurança.

---
## **Como funciona o desempacotamento?**
Quando um arquivo executável é embalado, ele passa por operações adicionais em comparação com um executável descompactado. Essas operações permitem que o arquivo empacotado seja executado com sucesso no sistema. A imagem a seguir ilustra este processo passo a passo:

![](https://letsdefend-images.s3.us-east-2.amazonaws.com/Courses/Static-Malware-Analysis/4.Packing+and+Unpacking/packing2.png)

O processo na imagem acima é explicado da seguinte forma:

1. A seção específica destacada nesta fase é chamada de ponto de entrada. Ele mostra a etapa inicial a ser executada quando o arquivo executável empacotado é executado. Devido ao arquivo ser embalado, o ponto de entrada aponta para a seção contendo o mecanismo de desempacotamento.
2. Nesta fase, a desembalicada é aplicada à seção "Escutável Embalado" usando o desempacotamento.
3. Nesta fase, o "Executável Original Unpacked" resultante do processo de descompactar no estágio anterior é escrito na seção vazia.
4. Durante este estágio, o controle do fluxo do programa transita do desempacotamento para o executável original.
5. Finalmente, o executável que foi descompactado com sucesso é executado.

  ---
## **Empacotadores**

Existem embaladores comerciais, bem como empacotadores personalizados escritos pelos próprios atacantes. Algumas delas são de código aberto. Alguns empacotadores são mostrados na imagem abaixo:
  
![](https://letsdefend-images.s3.us-east-2.amazonaws.com/Courses/Static-Malware-Analysis/4.Packing+and+Unpacking/packing3.png)

  
  
  
---
## **Tipos de Packers**
Categorizar empacotadores em tipos específicos pode ser desafiador porque um único empacotador pode servir a vários propósitos, dificultando a classificação clara. No entanto, a seguinte classificação é fornecida, uma vez que é considerada a mais adequada:

**Nota:** Deve-se notar que uma classificação diferente pode ser incluída em outra fonte.

Os empacotadores podem ser divididos em 3 grupos:

- Compressão de Packers
- Empacotadores de criptografia (cripters)
- Embalagem de proteção (protetores)

**Compressão de Packers**
"Empacotadores de compressão" são empacotadores que reduzem o tamanho de um arquivo executável. No passado, esses empacotadores eram comumente usados para resolver as limitações representadas pelas velocidades lentas da Internet e pela capacidade de armazenamento limitada. No entanto, atualmente, a tecnologia atingiu uma certa maturidade e o tamanho dos arquivos executáveis não é mais uma preocupação significativa.

**Empacotadores de criptografia (cripters)**
Os empacotadores de criptografia (Crypters) são projetados para criptografar o arquivo executável, tornando extremamente desafiador extrair informações usando técnicas de análise de malware estáticos. Além disso, os empacotadores de criptografia representam dificuldades para soluções de segurança na detecção de malware. Os desenvolvedores de malware frequentemente empregam esse tipo de embalagem para tornar seu malware totalmente indetectável (FUD).

**Embalagem de proteção (protetores)**
Proteger os empacotadores são um tipo de empacotador usado por fornecedores de desenvolvedores de software. Com esses empacotadores, os fornecedores de software visam impedir que o código-fonte de arquivos executáveis de seus produtos seja interceptado por técnicas de engenharia reversa. Esses empacotadores geralmente usam algoritmos de compressão e algoritmos de criptografia.

>**Nota:** Como os empacotadores não são estritamente separados por suas funções, um invasor pode usar um empacotador com recursos de compactação e criptografia como um empacotador para tornar o malware totalmente indetectável (FUD). Os analistas SOC são recomendados para levar isso em conta ao realizar análises de malware estático.

---
## **Detectando os empacotadores com DIE (Detect It Easy)**
Várias ferramentas estão disponíveis para determinar o empacotador usado em uma amostra de malware. Este tutorial utiliza a ferramenta "DIE (Detect It Easy)" para detecção de empacotador. Você pode acessar a ferramenta a partir do seguinte endereço:

**DIE(Detect It Easy):** [https://github.com/horsicq/DIE-engine/releases](https://github.com/horsicq/DIE-engine/releases)

Uma ferramenta de detecção de empacotador pode não detectar todos os empacotador. Portanto, recomenda-se usar mais de uma ferramenta de detecção de empacotador. Algumas ferramentas de detecção de empacotador são as seguintes:

- DIE (Deteja-o fácil)
- PEStudio em IoP
- Explorador do CFF
- PEiD em
- ExeinfoPE em


![](https://letsdefend-images.s3.us-east-2.amazonaws.com/Courses/Static-Malware-Analysis/4.Packing+and+Unpacking/packing4.png)

Ao iniciar a ferramenta DIE, uma janela como a acima aparece. O arquivo de malware é dado ao programa com a ajuda do botão no canto superior direito.

![](https://letsdefend-images.s3.us-east-2.amazonaws.com/Courses/Static-Malware-Analysis/4.Packing+and+Unpacking/packing5.png)


Como demonstrado na imagem acima, a ferramenta detectou com sucesso o empacotador usado para empacotar o malware. Ferramentas semelhantes, incluindo esta, empregam assinaturas para identificar empacotadores específicos durante o processo de detecção.

**Nota:** Seria mais útil realizar a análise, considerando que um empacotador pode ter mais de uma assinatura diferente. Os Packers podem ter assinaturas variadas dependendo da sua versão.

Há uma lista de assinaturas de alguns empacotadores no endereço abaixo.

**[Lista de Assinatura do Packer](https://github.com/sooshie/packerid/blob/master/userdb.txt)**

Para ilustrar ainda mais o processo, podemos abrir o arquivo de malware em um editor hexadecimado chamado "HxD" e utilizar seu recurso de pesquisa para encontrar a assinatura associada ao packer.

**Assinatura(Sexto**): 60 E8 03 00 00 00 E9 EB 04 5D 45 55 C3 E8 01 00 00 EB 5D BB ED FF FF FF FF 03 DD 81 EB


![](https://letsdefend-images.s3.us-east-2.amazonaws.com/Courses/Static-Malware-Analysis/4.Packing+and+Unpacking/packing6.png)


![](https://letsdefend-images.s3.us-east-2.amazonaws.com/Courses/Static-Malware-Analysis/4.Packing+and+Unpacking/packing7.png)

Como visto na imagem acima, a assinatura que estamos procurando está localizada no deslocamento 4201.

---
## **Detectando os Packers manualmente**
Nos tópicos anteriores, é determinado qual packer embala o malware automaticamente e com a ajuda de uma ferramenta. Sob este título, um método que pode ser usado para detectar o empacotador manualmente é explicado. Neste método, nos concentramos no **"Nome da Seção"** do arquivo executável. A tabela abaixo apresenta os nomes das seções associadas a vários empacotadores:

![](https://letsdefend-images.s3.us-east-2.amazonaws.com/Courses/Static-Malware-Analysis/4.Packing+and+Unpacking/packing8.png)


É possível encontrar o empacotador pesquisando nomes de seções com ferramentas de análise de malware estático. As seguintes ferramentas estão disponíveis para isso:

- PEview em
- O urso de PE
- Stud_PE (peque)

Para investigar mais bem o malware identificado usando o método de detecção automática do empacotador mencionado anteriormente, podemos analisar suas seções usando a ferramenta PE-bear:

![](https://letsdefend-images.s3.us-east-2.amazonaws.com/Courses/Static-Malware-Analysis/4.Packing+and+Unpacking/packing9.png)


Na imagem acima, o arquivo de malware é aberto com a ferramenta PE-bear e suas seções são exibidas. Ao examinar os nomes das seções, vê-se que existem nomes de seções especificados para o empacotador **"Aspack"** na tabela acima. Isso indica que o malware foi realmente embalado usando o empacotador **"Aspack".**


>**Nota:** Neste módulo de treinamento, os nomes das seções foram utilizados para a detecção manual do empacotador. No entanto, é crucial ter em mente que existem muitos outros aspectos dentro do malware que podem ser explorados durante a detecção manual do empacotador. É vital não negligenciar a exploração de áreas alternativas se a detecção de empacotadores se revelar desafiadora ou inconclusiva.  