---
tags:
  - MALWARE-ANALISYS
  - LetsDefend
---
# Análise Dinâmica de Malware Exemplo 1

**Nome do arquivo:** e-Archive Dekont.exe

**MD5 Hash:** 7a0093c743fc33a5e111f2fec269f79b

**SHA256 Hash:** 722ef401e5cbb067c5c3cfaa402774d3c75c08e0cc8cc4d7e6e66acfa53684088

## **Preparação**

Como nossas ferramentas de monitoramento listam todas as atividades que foram feitas desde o momento em que o malware foi executado, devemos executar essas ferramentas antes de executar o programa suspeito que temos. Caso contrário, não poderemos ver atividades maliciosas nessas ferramentas, mesmo que elas realizem atividades de software malicioso.

Vamos executar nossa ferramenta **'Process Hacker'** para ver as atividades do processo. 

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-54.png)

Para ver as atividades do arquivo, execute a ferramenta chamada “**Procmon**” no kit de ferramentas **SysInternals**. Esta ferramenta permite-nos ver as atividades de processo, arquivo, registo e rede. No entanto, como existem tantos registros, pode ser difícil ler e concluir resultados significativos. (Sim, mesmo que você não veja, seu sistema operacional realmente funciona muito em segundo plano!)

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-55.png)

Execute o RegShot para ver as atividades do registro. Tire uma foto pressionando o botão “1st shot” antes de executar o malware. Este processo levará algum tempo.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-56.png)

Você pode usar Wireshark e Fiddler para ver as atividades da rede. O Fiddler será suficiente, pois o malware que analisamos se comunica pelo protocolo HTTP.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-57.png)

## **Analisar**

Agora que concluímos os preparativos necessários antes de executar o malware, **você pode executar o malware em sua VM**.

Para uma melhor compreensão, examinaremos as atividades de processo, rede, registro e arquivo separadamente. Depois de analisar essas atividades, criaremos uma linha do tempo.

Depois de dar tempo suficiente para o malware realizar sua atividade, vamos tirar o segundo tiro pressionando o botão "2nd shot" da ferramenta Regshot.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-58.png)

### **Atividades de processo**

Como mencionamos anteriormente em nossa série de treinamento, existem algumas vantagens de detectar as atividades do processo primeiro. Como encontraremos muitos logs e atividades, o primeiro passo que precisamos fazer é detectar os processos pertencentes ao malware.

Quando examinamos os processos ocorridos pelo Process Hacker, vemos que apenas um processo pertencente ao malware está sendo executado.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-59.png)

Mas as coisas nem sempre são como parecem! Como o Process Hacker mostra apenas os processos que estão sendo executados momentaneamente, o malware pode ter criado um processo infantil no momento em que não monitoramos e o encerramos mais tarde.

Neste ponto, a ferramenta Procmon vem em nosso socorro. Se você pressionar o botão "Show Process Tree" no menu superior, o procmon mostrará a árvore de processo que ela criou para você durante o tempo em que gravou.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-60.png)

A árvore de processo fornecida pela Procmon completa essa falha do Process Hacker, pois também inclui processos encerrados.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-61.png)

Quando falamos sobre a imagem acima, vemos que o primeiro processo que executamos (9076 PID) executa a ferramenta chamada “schtasks.exe” pertencente ao Windows Task Scheduler (PID 4800) e, em seguida, executa seu próprio malware (7944 PID) novamente.

Antes de passar para outras atividades, vamos examinar o processo schtasks.exe. O Schtasks.exe é uma ferramenta que permite que o Agendador de Tarefas seja usado através da interface de comando no sistema operacional Windows. Os atacantes garantem a persistência adicionando seu próprio malware às tarefas agendadas com a ajuda do Agendador de Tarefas.

Para ver que tipo de tarefa agendada o atacante adicionou, devemos clicar no "schtasks.exe" (4800 PID) na árvore de processo do procmon e examinar seus detalhes.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-62.png)

Quando examinamos os argumentos da linha de comando, vemos que uma tarefa agendada chamada "Updates-VbxFiQQYCyFDgGL" foi criada. No entanto, as informações da tarefa agendada, exceto para o seu nome, estão no arquivo XML localizado no seguinte caminho:

“C: Users’Amanda-AppData?Local ?Tmp.

Clique [aqui](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks) para obter informações sobre os argumentos da linha de comando da ferramenta chamada Schtasks.exe.

Quando você tenta acessar o arquivo relevante, você pode ver que o arquivo é excluído. Mas não se preocupe, esta tarefa agendada agora é salva para que possamos vê-la através da tarefa do Agendador.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-63.png)

Na guia Agatilho, você pode ver em quais situações essa tarefa agendada adicionada pelo invasor será executada. Como ele pode ser visto na captura de tela acima, essa tarefa agendada será executada no log.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-64.png)

Você pode ver qual ação será executada na guia Ações. Você pode ver na captura de tela acima que o software malicioso chamado “VbxFiQYCyFDgGL.exe” preparado pelo invasor será executado quando essa tarefa agendada for executada.

É assim que detectamos a tarefa agendada que o invasor adicionou.

Detectamos processos de malware (9076, 4800, 7944 PIDs) com a ajuda do Procmon. Em seguida, precisamos detectar a rede, o arquivo e as atividades de registro desses processos.

Você filtra os processos com valores de PID de 9076, 4800, 7944 no Procmon. No entanto, existe um método mais fácil. Quando você clicar com o botão direito do mouse sobre o processo principal do malware e pressionar o botão "Adicionar processo e crianças para Incluir filtro", o procmon criará esses filtros para você.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-65.png)

### **Atividades em rede**

  

Como o malware que examinamos se comunica pelo protocolo HTTP, você pode detectar as conexões que ele estabelece muito facilmente usando a ferramenta Fiddler.

Depois de executar o malware, você pode ver que o processo chamado “e-archive dekont.exe” em Fiddler se comunica com o domínio **“5gw4d[.]xyz** ”.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-66.png)

### **Atividades de registro**

  

Quando examinamos as atividades de registro, você pode ver que as chaves em HKLM?Software?WOW6432Node-Microsoft?Windows-CurrrentVersion?Uninstall são consultadas. Existem configurações sob esta chave que são deixadas pelos aplicativos instalados no sistema para desinstalar. Muitas vezes é preferível enumerar essa chave para detectar aplicativos instalados no sistema por invasores.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-67-1024x686.png)

### **Atividades de Arquivos**

  

Para detectar atividades de arquivos de malware, desabilite as outras três atividades no menu superior do procmon.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-68.png)

Você pode inserir um filtro com o Operation-CreateFile para ver as atividades de criação de arquivos.

Quando examinamos os logs, vemos que um arquivo executável chamado "VbxFiQYCyFDgGL.exe" está escrito no diretório "C:?Usser'Amanda'Appda?Roaming?".

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-69-1024x291.png)

Quando olhamos para o hash do aplicativo chamado “VbxFiQYCyFgGG.exe” com a ferramenta chamada HashMyFiles, vemos que ela é realmente o mesmo arquivo que o arquivo que analisamos primeiro. Vemos que o malware se copia para uma pasta diferente.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-70.png)

Quando examinamos as atividades do arquivo, vemos que o malware lê os arquivos para roubar informações de aplicativos como Firefox, Chome, Thunderbird. Nós determinamos que o malware que temos é o ladrão de informações.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-71-1024x388.png)

  

## **Resultado**

Agora que concluímos a análise de malware, podemos combinar as informações que reunimos. Nós detectamos que:

- o malware copiou-se para o directório "C:'Users'Username-AppData'Roaming" com o nome "VbxFiYYCyFDgGL.exe,"
- usou o Agendador de Tarefas para garantir a persistência,
- Incediu que seu próprio aplicativo malicioso fosse executado em cada logon, criando uma tarefa agendada com o nome "VbxFiQYCyFDgGL"
- comunica com o comando & o servidor de controle,
- o endereço de controle de comando é “5gw4d[.]xyz/PL341/index.php” e se comunica através do protocolo HTTP,
- descobre os aplicativos instalados no sistema com a ajuda da chave sob a chave "HKLM-SOFTWARE-WOW6432Node-Microsoft-Windows-Windows-CurrentVersion" chave de registro,
- Rouba dados confidenciais de aplicativos como Chrome, Firefox, Thunderbird.

### **Artefatos**

MD5: 7a0093c743fc33a5e111f2fec269f79b  
SHA256: 722ef401e5cbb067c5c3faa402774d3c75ef08e0c8cc4d7e6e6a9cfa536840  
Nome do arquivo: e-Archive Dekont.exe  
Nome do arquivo: VbxFiQYCyFDgGG.exe  
Domínio: 5gw4d[.]xyz  
URL: http[:]//5gw4d[.]xyz/PL341/index.php