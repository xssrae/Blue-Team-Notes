# Análise estática de malware
As principais perguntas que você tentará responder quando começar a examinar um software potencialmente mal-intencionado são: Com que tipo de arquivo você está lidando, suas origens, os recursos do software e quando ele pode ter sido criado. Além disso, você terá de determinar se precisa ou não prosseguir com uma análise mais detalhada e de que maneira.

Neste módulo, você usará o Pestudio para realizar essa análise inicial.

---
# Ferramentas
Há várias ferramentas que você pode usar para realizar a análise estática inicial. Como mencionado anteriormente, você usará o [pestudio](https://www.winitor.com/) neste módulo.

Algumas outras ferramentas que oferecem funcionalidade semelhante incluem [CFF explorer](https://ntcore.com/?page_id=388), [PE bear](https://hshrzd.wordpress.com/pe-bear/), [PEiD](https://www.aldeid.com/wiki/PEiD) e [DIE](https://github.com/horsicq/Detect-It-Easy). 

Quando precisar se aprofundar em um *executável*, você provavelmente desejará usar algo como o IDA ou o [Ghidra](https://ghidra-sre.org/). Entretanto, esse tipo de análise aprofundada não faz parte do escopo deste módulo.

---
# Informações básicas
Ao abrir um arquivo pela primeira vez no pestudio, você verá uma janela semelhante a esta:

![[Pasted image 20240128175142.png]]

Abra o arquivo ``mystery.exe`` em sua área de trabalho usando o pestudio e observe algumas das informações exibidas inicialmente. Para fazer isso, inicie o pestudio usando o atalho na área de trabalho e arraste o ``mystery.exe`` para a janela ou use o menu do aplicativo para abri-lo.

Observação: não tente executar o executável. Ele não foi projetado para ser executado nessa situação e não funcionará.

## Hashes
Ao examinar um arquivo potencialmente mal-intencionado pela primeira vez, pode ser útil começar pegando o hash do arquivo. Nesse contexto, você pode pensar em um hash como uma impressão *digital do arquivo*. Quando você altera até mesmo um único bit de dados em um arquivo, o hash do arquivo será diferente. Os resultados de três algoritmos diferentes exibidos pelo pestudio (MD5, SHA1, SHA256) são efetivamente intercambiáveis para essa finalidade.

Também é possível calcular um hash apenas para determinadas partes do arquivo, como os *cabeçalhos* ou as *bibliotecas importada*s, também conhecido como imphash. ==Isso pode ser útil quando se está tentando comparar arquivos diferentes que se suspeita estarem relacionados.== Quando os autores de malware lançam novas versões, eles podem deixar algumas partes do arquivo inalteradas. O cálculo de hashes em partes específicas do arquivo é algo que o pestudio também faz para você.

## Tipo de arquivo
Geralmente, o pestudio analisará as informações do tipo de arquivo para você. Por exemplo, ele ==tentará detectar se você está lidando com um **executável** e para qual **arquitetura** ele foi compilado==. Além disso, se o pestudio não conseguir analisar nenhuma informação significativa, você poderá ver o motivo observando diretamente o conteúdo do arquivo.

Para essa finalidade, o pestudio mostra convenientemente os primeiros bytes de um arquivo. O arquivo que você está examinando no momento é um ***executável*** e você pode ver o início do cabeçalho **MZ** como seria de se esperar. Entretanto, se você visse uma assinatura diferente ou dados aleatórios no início do arquivo, saberia como proceder.
![[Pasted image 20240128175427.png]]

## Tempo de compilação
O ==registro de **data** e **hora** da compilação pode ser removido ou falsificado pelo desenvolvedor, mas ainda vale a pena examiná-lo==. Essas informações podem dizer quão recentemente a amostra foi criada - isso pode ser importante *se você estiver lidando com uma intrusão e estiver tentando entender se um invasor ainda está ativo*. Por exemplo, se a amostra foi compilada no dia anterior, é provável que o invasor esteja tentando ativamente usar essa ferramenta.

O tempo de compilação também é útil se você estiver examinando *várias amostras de malware* relacionadas e estiver tentando estabelecer uma linha do tempo. Se você tiver muitas amostras associadas, pode ser mais fácil iniciar sua análise com as amostras mais antigas. Elas podem ser mais fáceis de entender se o malware evoluiu e se tornou mais complexo com o tempo.

## Entropia
==A **entropia**, em termos simples, é uma **medida de aleatoriedade** e é um bom indicador para determinar se o arquivo está de alguma forma compactado ou empacotado==. Um executável compactado ou um arquivo de dados criptografados terá uma estrutura de aparência mais aleatória do que um arquivo executável normal que contém instruções da CPU, ou seja, os dados criptografados terão entropia mais alta. Portanto, ==se você observar que partes do arquivo ou o arquivo inteiro têm alta entropia, poderá supor que há dados compactados ou criptografados armazenados nele==.

>Observação: Entropia zero significa que não há aleatoriedade, por exemplo, um arquivo cheio de zeros, e o valor máximo de oito representa uma sequência de bits completamente aleatória. 

É essencial determinar se você está lidando com um executável que, de alguma forma, está empacotado, pois assim você sabe que precisa descompactá-lo antes de poder analisá-lo de forma significativa. Até lá, toda a funcionalidade estará oculta para qualquer análise estática. Você também pode obter uma indicação de que o executável está ou não empacotado examinando as importações.

>Observação: a entropia nem sempre é imediatamente reveladora, pois um executável compactado pode ter entropia semelhante a um que não foi compactado. A entropia é apenas um indicador.

---
# Bibliotecas e funções
As informações sobre bibliotecas e funções são provavelmente as mais reveladoras do que o malware pode querer realizar em termos gerais.

## Bibliotecas
Na exibição de bibliotecas, você verá uma ==lista de **bibliotecas importadas** por esse executável==. Isso lhe dará uma indicação do tipo de *funcionalidade* que a amostra pode ter. Há uma breve descrição da biblioteca no campo de descrição, mas você sempre pode pesquisar on-line para obter mais informações ou consultar a visualização de funções que, às vezes, pode ser mais descritiva, pois você pode ver quais funções a biblioteca oferece.

> Observação: A exibição de exportações é o que você deve observar ao analisar um arquivo DLL. Essa visualização lhe dirá qual funcionalidade a DLL expõe.

## Funções
A exibição de funções ==lista as **funções externas** potencialmente usadas pelo programa e é relativamente autoexplicativa==. O Pestudio também marcará as funções mais comumente usadas de forma abusiva ou *potencialmente perigosas* como ***não listadas***.

==Você pode ver que, como a ``ws2_32.dll`` foi marcada como ***denylisted***, todas as funções fornecidas por essa DLL também estão marcadas como tal==. Além disso, na exibição de funções, você pode ver que essa biblioteca implementa a funcionalidade de rede com mais facilidade.

Observação: Se quiser obter mais detalhes sobre uma determinada função, você pode pesquisá-la no Microsoft Docs.
==Se você vir apenas **algumas funções listadas** aqui ou apenas **algumas bibliotecas importadas**, isso pode significar que o **programa está empacotado** ou está resolvendo os endereços das bibliotecas e funções por si só==. Por exemplo, aqui está a lista de funções mostradas para um executável compactado [UPX](https://upx.github.io/):
**![[Pasted image 20240128182835.png]]

Como você pode ver, há apenas dez funções listadas. Compare esse número com o número de funções listadas para o arquivo que você está analisando.

Observação: Como observação lateral, esse aplicativo compactado tem uma entropia de 6,468.

---
# Outras informações
Além das informações discutidas anteriormente, alguns outros itens úteis exibidos pelo pestudio podem ser úteis para a inspeção.

## Cabeçalhos e seções
Essas informações geralmente não são tão relevantes para a análise inicial. Os aspectos relevantes aqui são analisados pelo pestudio e exibidos para você na visualização inicial do resumo. No entanto, se você precisar examinar os cabeçalhos ou as seções do arquivo mais de perto, o pestudio também exibirá essas informações com mais detalhes.

## Informação de Debug
As informações específicas que são de interesse particular na exibição de depuração são a [string PDB](https://en.wikipedia.org/wiki/Program_database) exibida no campo de caminho. Você não precisa entender como o arquivo PDB é usado. Nesse contexto, só é importante entender que esse caminho pode lhe dizer como o desenvolvedor chama esse programa ou projeto. 

## Strings
Às vezes, dar uma rápida olhada nas strings que o executável armazena na abertura pode fornecer algumas informações sobre a natureza do arquivo com o qual você está lidando. Por exemplo, o executável armazena cadeias de caracteres que sugerem funcionalidade (por exemplo, sessão CMD aberta) ou armazena algo que se pareça com um endereço C2?

Normalmente, esses tipos de cadeias de caracteres são armazenados criptografados, mas às vezes você pode ter sorte. O que você pode ver na exibição de cadeias de caracteres desse executável?

## Indicadores
A exibição de indicadores é um recurso específico do pestudio. Ele ==tentará analisar os **recursos de um executáve**l que possam indicar que ele é mal-intencionado==. Pode ser útil começar olhando aqui e vendo qualquer coisa interessante que o pestudio tenha extraído. Você deve conseguir ver aqui que o pestudio analisou o endereço IP e o caminho do PDB, que também podem ser encontrados nas exibições de strings e depuração.

==O recurso de indicadores também pode ser útil no sentido de que, se houver muitos sinais de alerta aqui, há uma chance maior de que você esteja lidando com algo que seja realmente mal-intencionado.== No entanto, lembre-se de que, ==se ferramentas como o pestudio *não informarem* nada suspeito, isso *não significa automaticamente que está tudo bem*==. Pode ser que esteja, mas é sua tarefa fazer essa avaliação.


