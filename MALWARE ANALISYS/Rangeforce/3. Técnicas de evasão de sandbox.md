---
tags:
  - MALWARE-ANALISYS
  - Rangeforce
---
Atualmente, as ferramentas de sandboxing são amplamente usadas para análise de malware e podem fornecer uma ótima visão do funcionamento interno do software mal-intencionado. Ao mesmo tempo, os agentes de ameaças estão constantemente buscando aprimorar seus malwares, introduzindo técnicas antidetecção mais novas e complicadas.

Este módulo apresenta um passo a passo, incluindo demonstrações, de algumas das técnicas de evasão de sandbox usadas pelo malware.
# Visão geral das técnicas de evasão
A ideia por traz da evasão de sandbox é simples - ==os criadores de malware querem evitar que o seu código malicioso seja executado num ambiente de sandbox para complicar a análise==. É importante compreender que, enquanto os defensores trabalham para melhorar as suas ferramentas de proteção, os agentes de ameaças estão constantemente inventando novas formas criativas de determinar se o seu malware está ou não a ser executado num ambiente de proteção.

É possível, no entanto, generalizar as abordagens e dividir as técnicas de evasão de sandbox utilizadas pelo malware moderno em vários grupos. Neste módulo, você aprenderá sobre os seguintes grupos:

- Análise do sistema,
- Consciência do ambiente,
- Técnicas baseadas no tempo,
- Comportamento semelhante ao humano.

> Observação: atualmente, não existe uma classificação padrão das técnicas de evasão de sandbox usadas pelos criadores de malware, portanto, cada empresa de segurança/pesquisador pode definir e agrupar essas técnicas de forma diferente. Lembre-se disso quando chegar aos exemplos práticos, pois a classificação usada pela sandbox Hybrid Analysis pode ser diferente das outras fontes mencionadas neste módulo.

Se quiser se aprofundar mais nas técnicas de evasão, consulte [esta lista](https://evasions.checkpoint.com/) compilada pela equipe da [Check Point Research](https://research.checkpoint.com/).

# Análise do sistema
O primeiro grupo de técnicas que você examinará é a análise do sistema, que incorpora verificações que se concentram nas propriedades gerais de **hardware** e **software** do sistema em que o malware é executado. Essas verificações geralmente tentam determinar se o sistema é uma sandbox com base em diferenças comuns entre as configurações de máquinas virtuais usadas para sandboxing de malware e sistemas bare-metal reais.
## Análise de hardware
Como os ambientes virtuais simplesmente emulam dispositivos de hardware, os desenvolvedores de malware têm muitos dados de sistema relacionados a hardware com os quais podem trabalhar para determinar se o código está sendo analisado em uma sandbox. Algumas das verificações comuns relacionadas ao hardware incluem:

- **Número de núcleos de CPU**: Muitas ferramentas automatizadas de sandboxing limitam o número de núcleos dedicados a uma máquina virtual a apenas um, enquanto a maioria dos computadores modernos tem mais de 4 núcleos.
- **Quantidade de RAM**: Da mesma forma que o número de núcleos de CPU, a quantidade de RAM dedicada a uma sandbox normalmente permaneceria baixa (menos de 2 GB), enquanto a maioria das máquinas modernas opera com pelo menos 4 GB de RAM.
- **Componentes de hardware conectados**: Por exemplo, você pode verificar se o HDD tem um nome e um ID de fornecedor definidos ou consultar os dispositivos de entrada/saída conectados, como mouses, teclados, monitores e alto-falantes (os sistemas virtualizados provavelmente não terão nenhum).
- **Verificar informações sobre a temperatura da CPU**: Outra técnica criativa, que foi detectada pela primeira vez no malware GravityRAT. O malware tentará consultar a temperatura do hardware, mas a chamada inevitavelmente apresentará erro se for executada em um ambiente virtualizado. Vale a pena observar, no entanto, que essa verificação não é perfeita, pois alguns sistemas físicos também não podem retornar esse tipo de informação, mas, ao mesmo tempo, ela provou ser bastante confiável contra máquinas virtuais.

## Análise de software
Outra subcategoria que também pode ser listada na Análise de sistema mais geral é a Análise de software. Muitas cepas de malware tendem a coletar informações sobre o sistema operacional, os usuários e os programas instalados no sistema para obter melhor conhecimento de seu ambiente e tentar impedir a análise de sandbox. Algumas das técnicas mais comuns incluem a verificação das seguintes informações:

- **Nome de usuário e nome do host**: As ferramentas de virtualização geralmente atribuem valores predefinidos aos usuários padrão, bem como às próprias máquinas virtuais, enquanto os hosts comuns tendem a ter nomes de usuário e nomes de host significativos.
- **Tempo de atividade**: Como as sandboxes normalmente são criadas com o único objetivo de executar o arquivo malicioso, um tempo de atividade curto no momento da execução do malware pode identificar um ambiente virtualizado.
- **Localidade do sistema**: É comum que o malware tenha uma configuração que o impeça de ser ativado em determinados países, o que pode ser determinado pela verificação da localidade do sistema operacional (idioma base) definida no host da vítima.
- **Se determinado software está instalado**: Normalmente, não há um bom motivo para que as sandboxes de malware tenham uma grande quantidade de programas instalados. Ao mesmo tempo, é provável que os seres humanos tenham reprodutores de mídia, videogames, etc., presentes em seus sistemas.

# Conscientização sobre o meio ambiente
A maioria das ferramentas de virtualização, como *VMWare*, *VirtualBox* ou *Hyper-V*, deixa determinados artefatos nas VMs criadas, que podem ser usados pelo malware para identificar uma sandbox. Quase todo tipo de malware moderno procurará ativamente esses artefatos, ou melhor, **indicadores de um ambiente virtualizado**, no sistema da vítima. Os indicadores comuns que o malware pode verificar para obter conhecimento do ambiente incluem:

- **Privilégios de depuração**: Se o malware for executado em um programa depurador ou em um ambiente sandbox, ele terá um *privilégio de depuração definido, pois o processo pai (depurador ou sandbox) também o tem*. Essa é uma das técnicas mais comuns e confiáveis observadas na natureza.
- **Arquivos/diretórios específicos**: As ferramentas de virtualização criam vários arquivos e diretórios em sistemas convidados (máquinas virtuais). Por exemplo, se o malware encontrar arquivos como `c:\windows\system32\drivers\VBoxGuest.sys`, `c:\windows\system32\drivers\VBoxMouse.sys ou c:\windows\system32\drivers\VBoxSF.sys`, ele poderá assumir com segurança que está sendo executado em uma sandbox controlada pelo *VirtualBox*.
- **Caminho completo para o executável**: Algumas sandboxes podem ter um diretório definido a partir do qual as amostras de malware são executadas. Elas também podem atribuir automaticamente um *nome de arquivo padronizado ao arquivo malicioso*, incluindo algo como amostra ou malware.
- **Processos em execução**: As ferramentas de virtualização tendem a ter *processos auxiliares específicos* em execução nos sistemas convidados, por exemplo, vmtoolsd.exe ou vboxtray.exe.
- **Chaves de registro**: Muitas chaves de registro que são definidas em máquinas virtuais não serão normalmente definidas nos sistemas normais.

Algumas dessas verificações podem gerar falsos positivos em hosts comuns (não em sandboxes) que estejam executando algum tipo de software de virtualização. É por isso que os desenvolvedores de malware geralmente adicionam várias (às vezes dezenas de) verificações para atingir um nível de certeza mais alto.

# Técnicas baseadas em tempo
Conforme mencionado anteriormente, as sandboxes criadas por ferramentas automatizadas, como o Hybrid Analysis, são ativadas para cada nova amostra de malware enviada. Normalmente, essas sandboxes também têm um tempo limitado disponível para a análise de uma determinada amostra, o que significa que, se o malware for configurado para atrasar sua execução, a sandbox provavelmente não conseguirá analisar todo o potencial da amostra. Algumas das técnicas baseadas em tempo mais populares incluem:

- **Execução atrasada simples**: Nesse caso, o malware simplesmente dormirá por um determinado período de tempo (que pode ser de horas, dias ou até semanas) antes de ser executado.
- **Definição de uma data/hora de execução específica por meio do Agendador de Tarefas**: Um malware pode ser programado para ser executado somente em uma determinada data ou em um determinado horário, que provavelmente não corresponderá à data e ao horário da tentativa de análise da sandbox.
- **Aguardando a reinicialização**: O malware se abstém de fazer qualquer coisa suspeita no sistema da vítima até a próxima reinicialização, o que, no caso da maioria das sandboxes automatizadas, nunca acontecerá.
- **Bomba lógica**: A execução do malware também pode ser adiada até que um determinado evento ocorra no sistema. Tecnicamente, atingir uma determinada data ou hora também pode ser chamado de condição lógica, mas, nesse caso, é mais comum chamar esse tipo de "detonação" de bomba-relógio.

# Comportamento semelhante ao humano
Há certas ações que parecem rotineiras para os usuários humanos, mas é improvável que sejam emuladas por uma sandbox - essa simples distinção pode ajudar o malware a identificar facilmente um ambiente virtualizado. Algumas técnicas e verificações que fazem uso dessa distinção incluem:

- **Número de documentos abertos recentemente**: A maioria dos usuários do Windows interage constantemente com documentos do Microsoft Office, portanto, faz sentido que o malware verifique se há documentos abertos recentemente.
- **Número de URLs no histórico do navegador**: Da mesma forma que a abertura de documentos, os usuários humanos tendem a navegar muito na Internet, portanto, um sistema sem histórico de navegação (ou com um pequeno número de URLs visitados) pareceria suspeito.
- **Detecção do movimento do cursor**: É provável que um usuário normal opere o sistema com um mouse ou trackpad, mas nem todas as ferramentas de sandboxing emulam a atividade do usuário, o que faz com que suas VMs tenham uma posição estática do cursor.
- **Solicitação de interação com o usuário**: Alguns malwares podem incluir interfaces gráficas de usuário (GUIs) que exigem interação do usuário, por exemplo, clicar em um botão Next ou Install. Algumas sandboxes têm um recurso de clique automático que procura botões e emula um usuário clicando neles; no entanto, esse recurso pode ser desativado definindo o nome e a legenda da classe do botão como algo incomum.
- **Esperar até que um documento seja rolado**: O malware que usa documentos do Word para se espalhar pode empurrar uma exploração para uma determinada página do documento, abusando da especificação de arquivo RTF da Microsoft. Isso garantirá que o código de exploração seja executado somente se o documento for rolado para baixo até um determinado ponto, o que é improvável de ser feito por uma sandbox. Você pode ler mais sobre essa técnica, bem como sobre outras técnicas de evasão baseadas na interação humana, aqui.